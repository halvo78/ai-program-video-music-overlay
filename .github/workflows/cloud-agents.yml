name: Cloud Agents - Distributed Processing

on:
  workflow_dispatch:
    inputs:
      agent_type:
        description: 'Agent type to run'
        required: true
        type: choice
        options:
          - video
          - music
          - image
          - voice
          - content
          - editing
          - optimization
          - analytics
          - safety
          - social
          - all
      workflow_mode:
        description: 'Workflow mode'
        required: false
        default: 'hybrid'
        type: choice
        options:
          - sequential
          - parallel
          - hybrid
      platform:
        description: 'Target platform'
        required: false
        type: choice
        options:
          - aws
          - docker
          - github-actions
          - all
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  push:
    branches: [main]
    paths:
      - 'app/agents/**'
      - 'app/workflows/**'
      - '.github/workflows/cloud-agents.yml'

jobs:
  cloud-agent-orchestrator:
    name: Cloud Agent Orchestrator
    runs-on: ubuntu-latest
    strategy:
      matrix:
        agent: ${{ github.event.inputs.agent_type == 'all' && fromJSON('["video", "music", "image", "voice", "content", "editing", "optimization", "analytics", "safety", "social"]') || fromJSON(format('["{0}"]', github.event.inputs.agent_type || 'video')) }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Configure AWS credentials
        if: github.event.inputs.platform == 'aws' || github.event.inputs.platform == 'all'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Set up Docker Buildx
        if: github.event.inputs.platform == 'docker' || github.event.inputs.platform == 'all'
        uses: docker/setup-buildx-action@v3
      
      - name: Run Agent - ${{ matrix.agent }}
        env:
          AGENT_TYPE: ${{ matrix.agent }}
          WORKFLOW_MODE: ${{ github.event.inputs.workflow_mode || 'hybrid' }}
          PLATFORM: ${{ github.event.inputs.platform || 'github-actions' }}
          LOG_LEVEL: INFO
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python -c "
          import asyncio
          from app.agents.orchestrator import AgentOrchestrator
          
          async def run_agent():
              orchestrator = AgentOrchestrator()
              result = await orchestrator.run_agent(
                  agent_type='${{ matrix.agent }}',
                  mode='${{ env.WORKFLOW_MODE }}',
                  platform='${{ env.PLATFORM }}'
              )
              print(f'Agent ${{ matrix.agent }} completed: {result}')
          
          asyncio.run(run_agent())
          "
      
      - name: Upload agent logs
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: agent-logs-${{ matrix.agent }}
          path: |
            logs/
            *.log
          retention-days: 7
      
      - name: Report agent status
        if: always()
        run: |
          echo "Agent ${{ matrix.agent }} status: ${{ job.status }}"
          echo "::notice title=Agent Status::Agent ${{ matrix.agent }} completed with status ${{ job.status }}"

  workflow-execution:
    name: Workflow Execution
    runs-on: ubuntu-latest
    needs: cloud-agent-orchestrator
    if: github.event.inputs.workflow_mode != 'sequential'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Execute workflow
        env:
          WORKFLOW_MODE: ${{ github.event.inputs.workflow_mode || 'hybrid' }}
          PLATFORM: ${{ github.event.inputs.platform || 'github-actions' }}
        run: |
          python -c "
          import asyncio
          from app.workflows.engine import WorkflowEngine, WorkflowMode
          
          async def execute_workflow():
              engine = WorkflowEngine()
              mode = WorkflowMode.${{ env.WORKFLOW_MODE.upper() }}
              result = await engine.create_video(
                  prompt='Test workflow execution',
                  mode=mode,
                  platforms=['tiktok']
              )
              print(f'Workflow completed: {result.status}')
          
          asyncio.run(execute_workflow())
          "

  agent-health-check:
    name: Agent Health Check
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Health check all agents
        run: |
          python -c "
          import asyncio
          from app.agents.orchestrator import AgentOrchestrator
          
          async def health_check():
              orchestrator = AgentOrchestrator()
              agents = ['video', 'music', 'image', 'voice', 'content', 
                       'editing', 'optimization', 'analytics', 'safety', 'social']
              for agent in agents:
                  try:
                      status = await orchestrator.health_check(agent)
                      print(f'{agent}: {status}')
                  except Exception as e:
                      print(f'{agent}: ERROR - {e}')
          
          asyncio.run(health_check())
          "
      
      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Agent Health Check Failed',
              body: 'One or more agents failed health check. Please investigate.',
              labels: ['bug', 'agents', 'health-check']
            })
